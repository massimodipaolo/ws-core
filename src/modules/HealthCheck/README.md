# HealthCheck

#### Table of Contents

1. [Description](#description)
1. [Setup](#setup)
   - [Requirements](#setup-requirements)
   - [Configuration](#setup-configuration)
     - [Route options](#setup-configuration-route)
     - [Checks options](#setup-configuration-checks)
       - [Common check options](#setup-configuration-checks-common)
       - [Storage](#setup-configuration-checks-storage)
       - [Memory](#setup-configuration-checks-memory)
       - [Process](#setup-configuration-checks-process)
       - [WinService](#setup-configuration-checks-winservice)
       - [Tcp](#setup-configuration-checks-tcp)
       - [Http](#setup-configuration-checks-http)
       - [AppLog](#setup-configuration-checks-applog)
         - [Log rule selector match options](#setup-configuration-checks-applog-selector)
     - [UI options](#setup-configuration-ui)
       - [Endpoint options](#setup-configuration-ui-endpoint)
       - [Webhook options](#setup-configuration-ui-webhook)
1. [Usage](#usage)
1. [Limitations](#limitations)
1. [Development](#development)

## <a id="description"></a>Description

The `HealthCheck` module install and configures the [ASP.NET Core Health Checks Middleware](https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks) for reporting the health of app infrastructure components.

Installing this module will automatically enable all the health checks defined by other installed modules (i.e. `Data.EF.SqlServer`, `Message`) and also custom checks defined in the `HealthCheck` module configuration.

This module also exposes generic interface `IAppLogService` for defining your own application log service health check.

## <a id="setup"></a>Setup

You can install the `HealthCheck` module adding the reference in your `Core` application and configure it in the `ext-settings.json` file.

### <a id="setup-requirements"></a>Requirements

No other modules are required.

### <a id="setup-configuration"></a>Configuration

You need to define 3 options:

1. **routes** (_optional_): list of health check [Route options](#setup-configuration-route). If not provided 2 default routes will be used:
   - `/healthz` for basic app status, with no additional check.
   - `/healthz/checks` for overall app status, performing all checks.
1. **checks** (_optional_): custom [Checks options](#setup-configuration-checks) configuration.
   - **storage** (_optional_): list of [Storage](#setup-configuration-checks-storage) check options.
   - **memory** (_optional_): [Memory](#setup-configuration-checks-memory) check options.
   - **process** (_optional_): list [Process](#setup-configuration-checks-process) check options.
   - **winService** (_optional_): list of [WinService](#setup-configuration-checks-winservice) check options.
   - **tcp** (_optional_): list of [Tcp](#setup-configuration-checks-tcp) check options.
   - **http** (_optional_): list of [Http](#setup-configuration-checks-http) check options.
   - **appLog** (_optional_): [AppLog](#setup-configuration-checks-applog) check options.
1. **ui** (_optional_): health checks [UI options](#setup-configuration-ui). If not provided default values will be used.

#### <a id="setup-configuration-route"></a>Route options

- **path**: route path (i.e. `/healthz`, `/healthz/checks`).
- **contentType** (_default_: `json`): `json`|`text`.
- **skipChecks** (_default_: `false`): if true skips any defined checks, returning a basic health check endpoint.
- **authPolicies** (_optional_): list of policy name to validate.
- **authHosts** (_optional_): list of authorized hosts (i.e. `host:8001`).

#### <a id="setup-configuration-checks"></a>Checks options

##### <a id="setup-configuration-checks-common"></a>Common check options

- **name** (_default_: **autogenerated guid**): check identifier.
- **status** (_default_: `Unhealthy`): `Unhealthy`|`Degraded`|`Healthy`. Health status on check failure.
- **tags** (_optional_): list of task tags.

##### <a id="setup-configuration-checks-storage"></a>Storage

In addition to [Common check options](#setup-configuration-checks-common):

- **driver**: drive name (i.e. `C:\\`). Skips check if empty.
- **minimumFreeMb**: minimum free drive space in MB threshold for triggering check failure (i.e. `1024 = 1Gb`).

##### <a id="setup-configuration-checks-memory"></a>Memory

In addition to [Common check options](#setup-configuration-checks-common):

- **maximumAllocatedMb**: maximum allocated memory in MB threshold for triggering check failure (i.e. `512`).

##### <a id="setup-configuration-checks-process"></a>Process

In addition to [Common check options](#setup-configuration-checks-common):

- **processName**: name of the process to check if it **exists**. Skips check if empty.

##### <a id="setup-configuration-checks-winservice"></a>WinService

In addition to [Common check options](#setup-configuration-checks-common):

- **serviceName**: name of the service to check if it is **running**. Skips check if empty.

##### <a id="setup-configuration-checks-tcp"></a>Tcp

In addition to [Common check options](#setup-configuration-checks-common):

- **host**: host to check if is alive and responding via tcp protocol. Skips check if empty.
- **port**: tcp port.

##### <a id="setup-configuration-checks-http"></a>Http

In addition to [Common check options](#setup-configuration-checks-common):

- **Url**: url to check it is alive and responding via http protocol. Skips check if empty.

##### <a id="setup-configuration-checks-applog"></a>AppLog

In addition to [Common check options](#setup-configuration-checks-common):

- **appLogService** (_optional_): `IAppLogService` concrete implementation class (i.e. `MyNamespace.MyServices.MyAppLogService, MyAssembly`). If not provided auto discovery will be used.
- **takeLastLog**: parse last logs by criteria. If not provided defaults options will be used.
  - **criteria** (_default_: `FromHours`): `FromHours`|`Top`.
  - **value** (_default_: `1`):
    - if `Top` criteria is used it represent the number of latest logs to take.
    - if `FromHours` is used it represents the threshold in hours of the latest logs to take.
- **healthStatusCheckers** list of health status checkers:
  - **level**: `Trace`|`Debug`|`Info`|`Warn`|`Error`|`Fatal`.
  - **minCounters** list of log level min counters:
    - **minEntry**: min occurrance to set a new healthStatus (i.e. above 1000 Warn set healthStatus `Degraded`).
    - **healthStatus**: `Unhealthy`|`Degraded`|`Healthy`.
- **logIgnoreRoles**: list of log ignore rules:
  - **level**: `Trace`|`Debug`|`Info`|`Warn`|`Error`|`Fatal`.
  - **selectors**: list of selector roles to ignore log for this severity level:
    - **logger**: [Log rule selector match options](#setup-configuration-checks-applog-selector).
    - **message**: [Log rule selector match options](#setup-configuration-checks-applog-selector).
  - **logMessageAggregate**:
    - **truncateLengthAt** (_default_: `255`): Message max chars. 0 to skip message aggregation. Range: 0 - 4000.
    - **maxLevenshteinDistanceFactor** (_default_: `50`): Levenshtein max distance factor (0-100 percent) used to aggregate messages. 0 = same string.

##### <a id="setup-configuration-checks-applog-selector"></a>Log rule selector match options

- **list**: list of strings to evaluate for the match.
- **role** (_default_: `EqualTo`): the performance order is `EqualTo` > `StartWith` > `Contains` > `RegEx`.

#### <a id="setup-configuration-ui"></a>UI options

- **enable** (_default_: `false`): enables `HealthChecksUI`.
- **route** (_default_: `/healthchecks-ui`): UI route path.
- **routeApi** (_default_: `/healthchecks-api`): API route path.
- **routeWebhook** (_default_: `/healthchecks-webhooks`): Webhooks route path.
- **injectCss** (_optional_): physical location of a custom stylesheet to inject (i.e. `wwwroot/healthcheck-ui/style.css`).
- **endpoints** (_optional_): list of health check [endopoint](#setup-configuration-ui-endpoint) to evaluate.
- **webhooks** (_optional_): list of [webhook](#setup-configuration-ui-webhook) notifications. If any health check returns a _Failure_ result, this collections will be used to notify the error status.
- **evaluationTimeinSeconds** (_default_: `60`): number of elapsed seconds between health checks.
- **minimumSecondsBetweenFailureNotifications** (_default_: `300`): the minimum seconds between failure notifications to avoid receiver flooding.
- **authPolicies** (_optional_): list of policy name to validate.
- **authHosts** (_optional_): list of authorized hosts (i.e. `host:8001`).

##### <a id="setup-configuration-ui-endpoint"></a>Endpoint options

- **name**: endpoint name.
- **uri**: endpoint uri. It can be a relative path (i.e. `/healthz/checks`) or an absolute path to an external endopoint. Skip check if empty.

##### <a id="setup-configuration-ui-webhook"></a>Webhook options

- **name**: webhook name.
- **uri**: webhook uri (i.e. `/hook/notify`).
- **payload**: encoded payload for failed check. Available token: `[[LIVENESS]]`,`[[FAILURE]]`,`[[DESCRIPTIONS]]`.
- **restorePayload**: encoded payload for restored status. Available token: `[[LIVENESS]]`.

#### Configuration example

```json
{
  "extConfig": {
    "assemblies": {
      "Ws.Core.Extensions.HealthCheck": {
        "priority": 100,
        "options": {
          "routes": [
            {
              "path": "/healthz",
              "contentType": "text",
              "skipChecks": true
            },
            {
              "path": "/healthz/checks",
              "contentType": "json",
              "skipChecks": false,
              "_authHosts": ["localhost:32040"]
            }
          ],
          "checks": {
            "storage": [
              {
                "driver": "C:\\",
                "minimumFreeMb": 2048,
                "status": "Degraded",
                "name": "diskC",
                "tags": ["infrastructure", "on-premises"]
              }
            ],
            "memory": {
              "maximumAllocatedMb": 500,
              "status": "Degraded",
              "tags": ["infrastructure", "on-premises"]
            },
            "process": [
              {
                "processName": "devenv",
                "name": "devenv",
                "status": "Degraded",
                "tags": ["infrastructure", "on-premises"]
              }
            ],
            "tcp": [
              {
                "host": "127.0.0.1",
                "port": 2025,
                "name": "mailserver",
                "tags": ["infrastructure", "local", "smtp"]
              },
              {
                "host": "127.0.0.1",
                "port": 14331,
                "name": "mssql-01",
                "tags": ["infrastructure", "local", "db"]
              }
            ],
            "http": [
              {
                "url": "https://www.google.com",
                "name": "outbound",
                "status": "Unhealthy",
                "tags": ["network", "firewall"]
              }
            ],
            "appLog": {
              "appLogService": "testApp.HealthCheckAppLogService, testApp",
              "takeLastLog": {
                "criteria": "Top",
                "value": 1000
              },
              "logIgnoreRoles": [
                {
                  "level": "Warn",
                  "selectors": [
                    {
                      "logger": {
                        "list": ["ExternalApp.Hub.Controllers.TestController"]
                      }
                    },
                    {
                      "logger": {
                        "list": ["ExternalApp", "TestClient"],
                        "role": "StartWith"
                      }
                    }
                  ]
                },
                {
                  "level": "Error",
                  "selectors": [
                    {
                      "logger": {
                        "list": [
                          "TestClient.Server.Extensions.ImageSharpExtension",
                          "SixLabors.ImageSharp.Web.Middleware.ImageSharpMiddleware"
                        ],
                        "role": "EqualTo"
                      }
                    },
                    {
                      "logger": {
                        "list": ["NodeServices"],
                        "role": "Contains"
                      }
                    }
                  ]
                }
              ],
              "healthStatusCheckers": [
                {
                  "level": "Warn",
                  "minCounters": [
                    {
                      "minEntry": 1000,
                      "healthStatus": "Degraded"
                    },
                    {
                      "minEntry": 10000,
                      "healthStatus": "Unhealthy"
                    }
                  ]
                },
                {
                  "level": "Error",
                  "minCounters": [
                    {
                      "minEntry": 100,
                      "healthStatus": "Degraded"
                    },
                    {
                      "minEntry": 1000,
                      "healthStatus": "Unhealthy"
                    }
                  ]
                },
                {
                  "level": "Fatal",
                  "minCounters": [
                    {
                      "minEntry": 10,
                      "healthStatus": "Unhealthy"
                    }
                  ]
                }
              ],
              "logMessageAggregate": {
                "truncateLengthAt": 255,
                "maxLevenshteinDistanceFactor": 90
              },
              "tags": ["app"]
            }
          },
          "ui": {
            "enable": true,
            "injectCss": "wwwroot/healthcheck-ui/style.css",
            "endpoints": [
              {
                "uri": "/healthz/checks",
                "name": "web-app"
              }
            ],
            "webhooks": [
              {
                "name": "web",
                "uri": "/hook/healthz",
                "payload": "{\"title\": \"The HealthCheck '[[LIVENESS]]' is failing\",\"text\": \"Error message: [[FAILURE]]\\r\\n[[DESCRIPTIONS]]\",\"isFailure\": true}",
                "restorePayload": "{\"title\": \"The HealthCheck '[[LIVENESS]]' is recovered\",\"text\": \"All is up and running\"}"
              }
            ],
            "evaluationTimeInSeconds": 60,
            "minimumSecondsBetweenFailureNotifications": 300
          }
        }
      }
    }
  }
}
```

## <a id="usage"></a>Usage

You can access to the configured endpoints to monitor the health check status.

### Create custom health checks example

To create your own health checks you need to implement the [IHealthCheck](https://docs.microsoft.com/it-it/dotnet/api/microsoft.extensions.diagnostics.healthchecks.ihealthcheck) interface and add it to the `Add` method of the application `Startup` class or into the [Add](../ExtensionBase/README.md#usage) method of a module/extension.

```csharp
public class MyService : IHealthCheck
{
    public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context, CancellationToken cancellationToken = default)
    {
        // write health check implementation here...

        return await Task.FromResult(HealthCheckResult.Healthy());
    }
}
```

```csharp
public class Extension: Ws.Core.Extensions.Base.Extension
{
    public override void Add(WebApplicationBuilder builder, IServiceProvider serviceProvider = null)
    {
        // adding MyService health check implementation.
        builder.Services.AddHealthChecks().AddCheck<MyService>("my-service", tags: new[] {"custom", "service"});
    }
}
```

### Health check application log service usage example

To create your own health check application log service you need to implement `ILog` and `IAppLogService` interfaces.

```csharp
public record Log : ILog, IEntity<int>
{
    public int Id { get; set; }
    public string MachineName { get; set; } = "";
    public string Logger { get; set; } = "";
    public AppLog.LogLevel Level { get; set; }
    public string Message { get; set; } = "";
    public DateTime CreatedAt { get; set; } = DateTime.Now;
}
```

```csharp
namespace testApp;

public class HealthCheckAppLogService : IAppLogService
{
    private readonly IRepository<Log, int> _repo;

    public HealthCheckAppLogService(IRepository<Log, int> repo)
    {
        _repo = repo;
    }

    public IQueryable<ILog> List => _repo.List.Where(_ => new AppLog.LogLevel[]
    {
        AppLog.LogLevel.Warn,
        AppLog.LogLevel.Error,
        AppLog.LogLevel.Fatal
    }.Contains(_.Level));
}
```

You can register your `IAppLogService` implementation in 3 ways:

1. Setting the `appLogService` option in the [AppLog](#setup-configuration-checks-applog) module configuration.

```json
  "appLog": {
    "appLogService": "testApp.HealthCheckAppLogService, testApp",
  }
```

2. Adding a transient service in `Startup` class before extensions discovery

```csharp
public class Startup : Ws.Core.Startup<Ws.Core.AppConfig>
{
    public override void Add(WebApplicationBuilder builder)
    {
        // IAppLogService implementation service registration
        builder.Services.AddTransient(typeof(IAppLogService), typeof(Vidly.Core.Api.Infrastructure.HealthCheckAppLogService));

        base.Add(builder);
    }
}
```

3. Letting auto discovery register your implementation automatically.

## <a id="limitations"></a>Limitations

Nothing to report.

## <a id="development"></a>Development

Development note, contribution info, licensing to be defined.
